{% extends "main/layout.html" %}
{% load i18n %}
{% load auth_extras %}
{% block content %}

{% comment %} Manuscript Table {% endcomment %}

<script type="text/javascript">
    var MANUSCRIPT_LIST_JSON_URL = '{% url "manuscript_table" %}';
    // translations for datatables

    var dt_language = {
        "emptyTable":     "{% trans "No data available in table" %}",
        "info":           "{% trans "Showing _START_ to _END_ of _TOTAL_ entries" %}",
        "infoEmpty":      "{% trans "Showing 0 to 0 of 0 entries" %}",
        "infoFiltered":   "{% trans "(filtered from _MAX_ total entries)" %}",
        "infoPostFix":    "",
        "thousands":      ",",
        "lengthMenu":     "{% trans "Show _MENU_ entries" %}",
        "loadingRecords": "{% trans "Loading..." %}",
        "processing":     "{% trans "Processing..." %}",
        "search":         "{% trans "Search:" %}",
        "zeroRecords":    "{% trans "No matching records found" %}",
        "paginate": {
            "first":      "{% trans "First" %}",
            "last":       "{% trans "Last" %}",
            "next":       "{% trans "Next" %}",
            "previous":   "{% trans "Previous" %}"
        },
        "aria": {
            "sortAscending":  "{% trans ": activate to sort column ascending" %}",
            "sortDescending": "{% trans ": activate to sort column descending" %}"
        }
    }

    $(document).ready(function() {
        //var builtColumns = [];
        //var builtFields = [];
        dt_man_ajax = $.ajax({
            url: MANUSCRIPT_LIST_JSON_URL,
            cache: false,
            success: function (response) {
                var [columns_config, button_index] = constructTable(response.data[0]);
                var last_row;
                var select_timeout;
                //console.log(response.data)
                var table = $('#manuscript_table').DataTable({
                    language: dt_language,  // global variable defined in html
                    lengthMenu: [[5, 10, 25, 50], [5, 10, 25, 50]],
                    searching: true,
                    processing: true,
                                        //serverSide: true, //currently broken, not sure if needed
                    stateSave: true,
                    paging: true,
                    select: 'single',
                    columns: columns_config,
                    dom: 'Bfrtpl',
                    keys: true, //for keyboard
                    rowId: 'id', //for retaining selected row
                                        //dom: 'Bfrtip', //old setting which is broken, should understand better
                    data: response.data.slice(1),
                    buttons: [
                    {% if request.user|has_global_perm:'main.add_manuscript' %} 
                        {
                            text: '<i class="fas fa-plus"></i> &nbsp;Create Manuscript',
                            name: 'createManuscript',
                            action: function ( e, dt, node, config ) {
                                window.location.href = "manuscript/create";
                            },
                        },
                    {% endif %}
                        {
                            extend: 'collection',
                            text: 'Manuscript Details <i class="fas fa-angle-down"></i>',
                            fade: 0,
                            buttons: [
                                {% if request.user|has_global_perm:'main.add_manuscript' %} 
                                    {
                                        text: 'Edit',
                                        name: 'editManuscript',
                                        action: function ( e, dt, node, config ) {
                                            //console.log(dt.rows( { selected: true } ).data()[0][0])
                                            window.location.href = "manuscript/"+manuscript_id+"/edit";
                                        },
                                        enabled: false
                                    },
                                    {
                                        text: 'Edit Files',
                                        name: 'editManuscriptFiles',
                                        action: function ( e, dt, node, config ) {
                                            //console.log(dt.rows( { selected: true } ).data()[0][0])
                                            window.location.href = "manuscript/"+manuscript_id+"/editfiles";
                                        },
                                        enabled: false
                                    },
                                {% endif %}
                                {
                                    text: 'View',
                                    name: 'viewManuscript',
                                    action: function ( e, dt, node, config ) {
                                        //console.log(dt.rows( { selected: true } ).data()[0][0])
                                        window.location.href = "manuscript/"+manuscript_id+"/view";
                                    },
                                    enabled: false
                                },
                            ]
                        },
                        {
                            extend: 'collection',
                            text: 'Manuscript Members <i class="fas fa-angle-down"></i>',
                            fade: 0,
                            buttons: [
                                {% if request.user|has_group:GROUP_ROLE_AUTHOR or request.user|has_group:GROUP_ROLE_EDITOR %} 
                                    {
                                        text: 'Add Author',
                                        name: 'addAuthor',
                                        action: function ( e, dt, node, config ) {
                                            //console.log(dt.rows( { selected: true } ).data()[0][0])
                                            window.location.href = "manuscript/"+manuscript_id+"/addauthor";
                                        },
                                        enabled: false
                                    },
                                {% endif %}
                                {% if request.user|has_group:GROUP_ROLE_CURATOR %} 
                                    {
                                        text: 'Add Curator',
                                        name: 'addCurator',
                                        action: function ( e, dt, node, config ) {
                                            //console.log(dt.rows( { selected: true } ).data()[0][0])
                                            window.location.href = "manuscript/"+manuscript_id+"/addcurator";
                                        },
                                        enabled: false
                                    },
                                    {
                                        text: 'Add Verifier',
                                        name: 'addVerifier',
                                        action: function ( e, dt, node, config ) {
                                            //console.log(dt.rows( { selected: true } ).data()[0][0])
                                            window.location.href = "manuscript/"+manuscript_id+"/addverifier";
                                        },
                                        enabled: false
                                    },
                                {% endif %}
                            ]
                        }
                    ]
                })
                .on( 'select', function ( e, dt, type, indexes ) {
                    //We delay select until no events have fired for a bit so that we don't do a zillion queries
                    //and also jam up the submission table reloading
                    clearTimeout(select_timeout); //clear existing timeout if needed
                    select_timeout = setTimeout(select_later, 100);
                } )
                .on( 'deselect', function ( e, dt, type, indexes ) {
                    var count = dt.rows( { selected: true } ).count();
                    if(count == 0) { //This is not dynamic because we can't ensure we know all the possible buttons by looking at a certain row
                        dt.button('editManuscript:name').enable(false);
                        dt.button('editManuscriptFiles:name').enable(false);
                        dt.button('viewManuscript:name').enable(false);
                        dt.button('addAuthor:name').enable(false);
                        dt.button('addCurator:name').enable(false);
                        dt.button('addVerifier:name').enable(false);
                    }
                    document.getElementById("submission_table_holder").style.display = "none"; //hide element
                    //console.log('Table row deselected: ' + document.getElementById("submission_table").style.display);
                } )
                .on('key-focus', function (e, dt, cell, originalEvent) {
                    //'key-focus' triggers on mouse events too, which we don't want
                    if(originalEvent.type == "keydown" && cell.index().row != last_row) { 
                        //dt.rows().deselect();
                        dt.row( cell.index().row ).select();
                        last_row = cell.index().row;
                    }
                });
                var selected_row = 0
                if(table.cell( { focused: true } ) && table.cell( { focused: true } ).length) { 
                    selected_row = table.cell( { focused: true } ).index().row
                } else { //select cell if none selected, allows instant keyboard use
                    table.cell({ row: selected_row, column: 0 }).focus();
                }
                table.row(selected_row).select(); //uses 'keys' retained row it was on to actually select the row


                function select_later() {
                    manuscript_id = table.rows( { selected: true } ).data()[0][0] //Implicit globals are not best practice
                    var avail_buttons = table.rows( { selected: true } ).data()[0][button_index];
                    var createSubButton = false;
                    for(var i in avail_buttons) {
                        //console.log(avail_buttons[i])
                        if(avail_buttons[i] == 'createSubmission') {
                            createSubButton = true;
                        } else {
                            table.button(avail_buttons[i]+':name').enable(true);
                        }
                    }
                    document.getElementById("submission_table_holder").style.display = "block"; //show element
                    
                    if (typeof dt_submission !== 'undefined') {
                        console.log(dt_submission.context)
                        
                        //if (dt_submission.context.length) {
                        console.log("DESTROY")
                        dt_submission.destroy(); //there may be a better way to update instead of destroy https://datatables.net/manual/tech-notes/3
                        //}
                    }
                    createSubmissionTable("manuscript/"+ manuscript_id +"/submission_table", createSubButton)
                    //console.log('Table row selected: ' + document.getElementById("submission_table").style.display);
                }
            }
        })

    });

    //What is the goal here?
    // - Define array rendering
    // - make table more dynamic
    // - NAMES
    function constructTable(columns) {
        var columns_config = [];
        var button_index;
        //console.log("CONSTRUCT TABLE")
        for (var c in columns) {
            var column_settings = {name: columns[c]}
            if(columns[c] === 'buttons') {
                column_settings.visible = false;
                button_index = c;
            } else if(columns[c] === 'curation_id' || columns[c] === 'verification_id') { //MAD: why isn't this working? it is being called....
                column_settings.visible = false;
            }
            columns_config[c] = column_settings
            //console.log(column_settings);
        }
        //console.log(columns_config);
        return [columns_config, button_index];
    } 

</script>

<table id="manuscript_table" class="datatable table table-striped table-bordered" cellspacing="0" width="100%">
    <h5> Manuscripts </h5>
    <thead>
        {% for field in manuscript_columns %}
            <th>{{ field }}</th>
        {% endfor %}
    </thead>
    <tbody>
    </tbody>
</table>

{% comment %} Submission Table {% endcomment %}

<script type="text/javascript">
    //dt_submission;
    function sub_table_callback(table) {
        dt_submission = table;
        //use return_first variable here
    }

    function createSubmissionTable(url, createSubButton) { 
        console.log("Create sub outside")
        $.ajax({
            url: url,
            cache: false,
            success: function (response) {
                console.log("Create sub inside")
                var [columns_config, button_index] = constructTable(response.data[0]);
                //console.log(response.data)
                var table = $('#submission_table').DataTable({
                    language: dt_language,  // global variable defined in html
                    lengthMenu: [[25, 50, 100, 200], [25, 50, 100, 200]],
                    searching: true,
                    processing: true,
                    //serverSide: true, //currently broken, not sure if needed
                    stateSave: true,
                    select: 'single',
                    columns: columns_config,
                    dom: 'Bfrt',
                    //dom: 'Bfrtip', //old setting which is broken, should understand better
                    data: response.data.slice(1),
                    buttons: [
                        {% if request.user|has_group:GROUP_ROLE_AUTHOR %} 
                            {
                                text: '<i class="fas fa-plus"></i> &nbsp;Create Submission',
                                name: 'createSubmission',
                                action: function ( e, dt, node, config ) {
                                    window.location.href = "manuscript/"+ manuscript_id +"/createsubmission";
                                },
                                enabled: createSubButton //this is actually stored in the manuscript button column and passed in
                            },
                        {% endif %}
                        {
                            extend: 'collection',
                            text: 'Submission Details <i class="fas fa-angle-down"></i>',
                            fade: 0,
                            buttons: [
                                {% if request.user|has_group:GROUP_ROLE_AUTHOR %} 
                                    {
                                        text: 'Edit',
                                        name: 'editSubmission',
                                        action: function ( e, dt, node, config ) {
                                            //console.log(dt.rows( { selected: true } ).data()[0][0])
                                            window.location.href = "submission/"+submission_id+"/edit";
                                        },
                                        enabled: false
                                    },
                                    {
                                        text: 'Edit Files',
                                        name: 'editSubmissionFiles',
                                        action: function ( e, dt, node, config ) {
                                            //console.log(dt.rows( { selected: true } ).data()[0][0])
                                            window.location.href = "submission/"+submission_id+"/editfiles";
                                        },
                                        enabled: false
                                    },
                                {% endif %}
                                {
                                    text: 'View',
                                    name: 'viewSubmission',
                                    action: function ( e, dt, node, config ) {
                                        //console.log(dt.rows( { selected: true } ).data()[0][0])
                                        window.location.href = "submission/"+submission_id+"/view";
                                    },
                                    enabled: false
                                },
                            ]
                        },
                        {% if request.user|has_group:GROUP_ROLE_CURATOR %} 
                            {
                                text: '<i class="fas fa-plus"></i> &nbsp;Create Curation',
                                name: 'createCuration',
                                action: function ( e, dt, node, config ) {
                                    window.location.href = "submission/"+submission_id+"/createcuration";
                                },
                                enabled: false
                            },
                        {% endif %}
                        {
                            extend: 'collection',
                            text: 'Curation Details <i class="fas fa-angle-down"></i>',
                            fade: 0,
                            buttons: [
                                {% if request.user|has_group:GROUP_ROLE_CURATOR %} 
                                    {
                                        text: 'Edit',
                                        name: 'editCuration',
                                        action: function ( e, dt, node, config ) {
                                            //console.log(dt.rows( { selected: true } ).data()[0][0])
                                            window.location.href = "curation/"+curation_id+"/edit";
                                        },
                                        enabled: false
                                    },
                                {% endif %}
                                {
                                    text: 'View',
                                    name: 'viewCuration',
                                    action: function ( e, dt, node, config ) {
                                        //console.log(dt.rows( { selected: true } ).data()[0][0])
                                        window.location.href = "curation/"+curation_id+"/view";
                                    },
                                    enabled: false
                                },
                            ]
                        },

                        {% if request.user|has_group:GROUP_ROLE_VERIFIER %} 
                            {
                                text: '<i class="fas fa-plus"></i> &nbsp;Create Verification',
                                name: 'createVerification',
                                action: function ( e, dt, node, config ) {
                                    window.location.href = "submission/"+submission_id+"/createverification";
                                },
                                enabled: false
                            },
                        {% endif %}
                        {
                            extend: 'collection',
                            text: 'Verification Details <i class="fas fa-angle-down"></i>',
                            fade: 0,
                            buttons: [
                                {% if request.user|has_group:GROUP_ROLE_VERIFIER %} 
                                    {
                                        text: 'Edit',
                                        name: 'editVerification',
                                        action: function ( e, dt, node, config ) {
                                            //console.log(dt.rows( { selected: true } ).data()[0][0])
                                            window.location.href = "verification/"+verification_id+"/edit";
                                        },
                                        enabled: false
                                    },
                                    {
                                        text: 'View',
                                        name: 'viewVerification',
                                        action: function ( e, dt, node, config ) {
                                            //console.log(dt.rows( { selected: true } ).data()[0][0])
                                            window.location.href = "verification/"+verification_id+"/view";
                                        },
                                        enabled: false
                                    },
                                {% endif %}

                            ]
                        },
                    ]
                })
                .on( 'select', function ( e, dt, type, indexes ) {
                    //MAD: these should be rewritten to get values from the construct columns, probably means we'll need a separate function for each table
                    submission_id = dt.rows( { selected: true } ).data()[0][0] //Implicit globals are not best practice
                    curation_id = dt.rows( { selected: true } ).data()[0][2] //Implicit globals are not best practice
                    verification_id = dt.rows( { selected: true } ).data()[0][4] //Implicit globals are not best practice
                    avail_buttons = dt.rows( { selected: true } ).data()[0][button_index];
                    for(var i in avail_buttons) {
                        dt.button(avail_buttons[i]+':name').enable(true);
                    }

                    console.log('Table row selected');
                } )
                .on( 'deselect', function ( e, dt, type, indexes ) {
                    var count = dt.rows( { selected: true } ).count();
                    if(count == 0) { //This is not dynamic because we can't ensure we know all the possible buttons by looking at a certain row
                        dt.button('editSubmission:name').enable(false);
                        dt.button('createCuration:name').enable(false);
                        dt.button('editCuration:name').enable(false);
                        dt.button('createVerification:name').enable(false);
                        dt.button('editVerification:name').enable(false);                                     
                        dt.button('viewSubmission:name').enable(false);
                        dt.button('viewCuration:name').enable(false);
                        dt.button('viewVerification:name').enable(false);                                      
                    }
                    console.log('Table row deselected');
                } ).row(':last').select();
                sub_table_callback(table)
            }
            })
    };
</script>

{% comment %} <div id="submission_table_wrapper" style="display:none"> {% endcomment %}
<div style="display:block" id="submission_table_holder">
    <table id="submission_table" class="datatable table table-striped table-bordered" cellspacing="0" width="100%">
        <hr>
        <h5> Submissions </h5>
        <thead>
            {% for field in submission_columns %}
                <th>{{ field }}</th>
            {% endfor %}
        </thead>
        <tbody>
        </tbody>
    </table>
</div >
{% comment %} </div> {% endcomment %}

{% endblock %}